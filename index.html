<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Task Timer â€” Tasks With Subtasks</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#121212" media="(prefers-color-scheme: dark)">
  <style>
    :root{
      --blue:#007aff;
      --green:#34c759;
      --red:#ff3b30;
      --orange:#ff9500;
      --gray:#8e8e93;
      --bg:#f0f0f0;
      --muted:#666;
    }
    *{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%;overflow-x:hidden}
    body{min-height:100dvh;overflow-x:hidden}
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg)}
    .container{max-width:520px;margin:0 auto;padding:20px;padding-bottom:72px}
    h1{margin:0 0 12px;text-align:center;color:var(--blue)}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 5px rgba(0,0,0,.08);padding:14px;margin:16px 0;min-height:88px;display:flex;flex-direction:column;justify-content:center}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .row > *{min-width:0}
    .row.center{justify-content:center}
    button{appearance:none;border:0;border-radius:8px;background:var(--blue);color:#fff;padding:10px 12px;font-size:15px;cursor:pointer}
    .btn{padding:6px 10px;font-size:14px;border-radius:6px;height:36px;display:flex;align-items:center;justify-content:center}
    .btn.green{background:var(--green)}
    .btn.red{background:var(--red)}
    .btn.gray{background:var(--gray)}
    .btn.orange{background:var(--orange)}
    .icon-btn{background:transparent;color:var(--blue);border:1px solid #e5e5e5;border-radius:8px;width:36px;height:36px;display:grid;place-items:center;padding:0;line-height:1}
    .icon-btn.gray{color:#555}
    .icon-btn:hover{background:#f5f7ff}
    .icon-btn:active{transform:translateY(1px)}
    input[type="text"]{ flex:1; padding:10px; font-size:16px; border:1px solid #ddd; border-radius:8px; background:var(--bg); transition:border-color .15s ease, box-shadow .15s ease }
    input[type="text"]:focus{ outline:none; border-color:#c7d2fe; box-shadow:0 0 0 3px rgba(99,102,241,.15); background:var(--bg) }
    .task-header{display:grid;grid-template-columns:minmax(0,1fr) auto;align-items:center;column-gap:10px}
    .task-header > :first-child{min-width:0}
    .task-title{font-weight:600;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;word-break:break-word}
    .controls{display:flex;gap:6px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .time{color:#333; font-variant-numeric:tabular-nums; letter-spacing:.2px}
    .muted{color:var(--muted); font-size:13px}
    .title-line.completed{text-decoration:line-through; color:#666}
    .time.dim{opacity:.8}
    /* Subtasks container: transparent by default; shaded only when open */
    .subtasks{margin-top:8px;border-radius:8px;background:transparent;padding:0;border:0}
    .subtasks.open{border-top:1px dashed #eee;padding:8px;background:#f9f9f9}
    .subtask{display:grid;grid-template-columns:minmax(0,1fr) auto;align-items:center;column-gap:8px;padding:6px 8px;border:1px solid #f1f1f1;border-radius:10px;margin:6px 0;background:#fff}
    .subtask .title-line strong{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;word-break:break-word}
    .subtask.in-progress{border-left:4px solid var(--blue); background:#f7fbff}
    .subtask.completed{opacity:.8}
    .sub-controls{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .small{font-size:12px}
    .footer-wrap{position:sticky;bottom:0;left:0;right:0;padding:10px 12px;background:rgba(240,240,240,.95);backdrop-filter:saturate(180%) blur(10px);border-top:1px solid #eaeaea;z-index:10}
    .footer{max-width:520px;margin:0 auto;display:flex;justify-content:center}

    .theme-toggle{position:fixed;top:12px;right:12px;z-index:10}

    /* Dark theme */
    body.theme-dark { --bg:#121212; --muted:#aaa; }
    body.theme-dark { background:var(--bg); color:#f0f0f0; }
    body.theme-dark .card{ background:#1e1e1e; border:1px solid #2a2a2a; box-shadow:0 1px 3px rgba(0,0,0,.6) }
    body.theme-dark .subtasks.open{ background:#1a1a1a; border:1px solid #2a2a2a }
    body.theme-dark .subtask{ background:#2a2a2a; border:1px solid #3a3a3a }
    body.theme-dark input[type="text"]{ background:#1e1e1e; color:#f0f0f0; border:1px solid #333 }
    body.theme-dark .footer-wrap{ background:#1e1e1e; border-top-color:#333 }
    body.theme-dark .btn{ background:#333; color:#eee }
    body.theme-dark .icon-btn{ border-color:#333; color:#eee }
    body.theme-dark .btn.green{ background:#2e7d32; color:#fff }
    body.theme-dark .btn.red{ background:#c62828; color:#fff }
    body.theme-dark .btn.orange{ background:#ef6c00; color:#fff }
    body.theme-dark .btn.gray{ background:#444; color:#eee }

    /* Small-screen tweaks */
    @media (max-width: 480px){
      .container{padding:14px;padding-bottom:72px}
      .card{margin:12px 0;padding:10px;border-radius:10px}
      .row{gap:8px}
      .icon-btn{width:32px;height:32px;border-radius:7px}
      .btn{height:32px;padding:5px 8px;font-size:13px}
      input[type="text"], input, select, textarea{padding:9px;font-size:16px}
      h1{font-size:20px;margin-bottom:10px}
      .muted{font-size:12px}
      .footer-wrap{padding:8px 10px}
    }
  </style>
</head>
<body>
  <button class="icon-btn theme-toggle" title="Toggle theme" aria-label="Toggle theme" onclick="document.body.classList.toggle('theme-dark')">ðŸŒ“</button>
  <div class="container">
    <h1>Task Timer â€” Subtasks</h1>
    <div class="card">
      <div class="row" style="gap:8px">
        <input id="taskInput" type="text" placeholder="New main task..." />
        <button id="addTaskBtn" class="icon-btn" title="Add main task" aria-label="Add main task">ï¼‹</button>
      </div>
    </div>
    <div id="taskList"></div>
  </div>

  <div class="footer-wrap" id="footerBar" style="display:none">
    <div class="footer">
      <button id="clearAllBtn" class="btn orange">Clear all completed</button>
    </div>
  </div>

  <script>
  // ===== State =====
  var tasks = [];
  var activeRef = null; // { type:'task'|'sub', taskId:number, subId?:number }
  var timerInterval = null;
  var nextId = 1; // monotonic id
  function uid(){ return nextId++; }

  // ===== Utils =====
  function fmt(s){ var h=Math.floor(s/3600),m=Math.floor((s%3600)/60),x=s%60; return (h+'').padStart(2,'0')+':'+(m+'').padStart(2,'0')+':'+(x+'').padStart(2,'0'); }
  function hasSubtasks(t){ return t.subtasks && t.subtasks.length>0; }
  function getTask(id){ for(var i=0;i<tasks.length;i++){ if(tasks[i].id===id) return tasks[i]; } return null; }
  function getSubtask(taskId, subId){ var t=getTask(taskId); if(!t) return null; for(var i=0;i<t.subtasks.length;i++){ if(t.subtasks[i].id===subId) return t.subtasks[i]; } return null; }
  function parentSeconds(t){ var d=t.parent.duration; if(activeRef && activeRef.type==='task' && activeRef.taskId===t.id && t.parent.startTime){ d += Math.floor((Date.now()-t.parent.startTime)/1000); } return d; }
  function sumSubSeconds(t){ var acc=0; for(var i=0;i<t.subtasks.length;i++){ var st=t.subtasks[i]; var d=st.duration; if(activeRef && activeRef.type==='sub' && activeRef.taskId===t.id && activeRef.subId===st.id && st.startTime){ d += Math.floor((Date.now()-st.startTime)/1000); } acc+=d; } return acc; }
  function totalSeconds(t){ return hasSubtasks(t) ? sumSubSeconds(t) : parentSeconds(t); }
  function isTaskCompleted(t){ if(!hasSubtasks(t)) return t.parent.status==='completed'; if(t.subtasks.length===0) return false; for(var i=0;i<t.subtasks.length;i++){ if(t.subtasks[i].status!=='completed') return false; } return true; }
  function safeStopTickerIfIdle(){ if(!activeRef){ clearInterval(timerInterval); timerInterval=null; } }

  // ===== CRUD main tasks =====
  function addTask(){ var input=document.getElementById('taskInput'); var name=(input.value||'').trim(); if(!name) return; tasks.push({id:uid(),name:name,collapsed:true,parent:{status:'pending',duration:0,startTime:null},subtasks:[]}); input.value=''; render(); }
  function deleteTask(taskId){ if(activeRef && activeRef.taskId===taskId){ completeActive(); } tasks = tasks.filter(function(t){return t.id!==taskId}); safeStopTickerIfIdle(); render(); }

  // ===== Parent timer (no subtasks) =====
  function startParent(taskId){ var t=getTask(taskId); if(!t||hasSubtasks(t)) return; if(activeRef) completeActive(); t.parent.status='in-progress'; t.parent.startTime=Date.now(); activeRef={type:'task',taskId:taskId}; startTicker(); render(); }
  function stopParent(taskId){ var t=getTask(taskId); if(!t||hasSubtasks(t)||t.parent.status!=='in-progress') return; t.parent.duration += Math.floor((Date.now()-t.parent.startTime)/1000); t.parent.startTime=null; t.parent.status='completed'; if(activeRef && activeRef.type==='task' && activeRef.taskId===taskId){ activeRef=null; clearInterval(timerInterval);} render(); }
  function resetParent(taskId){ var t=getTask(taskId); if(!t||hasSubtasks(t)) return; if(activeRef && activeRef.type==='task' && activeRef.taskId===taskId){ activeRef=null; clearInterval(timerInterval);} t.parent.status='pending'; t.parent.duration=0; t.parent.startTime=null; render(); }

  // ===== Subtasks & collapsing =====
  function expandToAdd(taskId){ var t=getTask(taskId); if(!t) return; t.collapsed=false; render(); var inp=document.getElementById('subInput-'+taskId); if(inp){ try{ inp.focus(); }catch(e){} } }
  function collapseCard(taskId){ var t=getTask(taskId); if(!t) return; t.collapsed=true; render(); }
  function toggleCollapse(taskId){ var t=getTask(taskId); if(!t) return; t.collapsed=!t.collapsed; render(); }

  function addSubtask(taskId){ var inp=document.getElementById('subInput-'+taskId); var name=(inp && inp.value ? inp.value : '').trim(); if(!name) return; var t=getTask(taskId); if(!t) return; if(!hasSubtasks(t) && t.parent.startTime){ t.parent.duration += Math.floor((Date.now()-t.parent.startTime)/1000); t.parent.startTime=null; t.parent.status='completed'; if(activeRef && activeRef.type==='task' && activeRef.taskId===taskId){ activeRef=null; clearInterval(timerInterval);} } t.subtasks.push({id:uid(),name:name,status:'pending',duration:0,startTime:null}); if(inp){ inp.value=''; setTimeout(function(){ inp.focus(); },0); } render(); setTimeout(function(){ var ref=document.getElementById('subInput-'+taskId); if(ref) ref.focus(); },0); }
  function startSubtask(taskId, subId){ var st=getSubtask(taskId, subId); var t=getTask(taskId); if(!st||st.status==='completed'||!t) return; if(activeRef) completeActive(); st.status='in-progress'; st.startTime=Date.now(); activeRef={type:'sub',taskId:taskId,subId:subId}; startTicker(); render(); }
  function stopSubtask(taskId, subId){ var st=getSubtask(taskId, subId); var t=getTask(taskId); if(!st||st.status!=='in-progress'||!t) return; st.duration += Math.floor((Date.now()-st.startTime)/1000); st.startTime=null; st.status='completed'; if(activeRef && activeRef.type==='sub' && activeRef.taskId===taskId && activeRef.subId===subId){ activeRef=null; clearInterval(timerInterval);} render(); }
  function resetSubtask(taskId, subId){ var st=getSubtask(taskId, subId); if(!st) return; if(activeRef && activeRef.type==='sub' && activeRef.taskId===taskId && activeRef.subId===subId){ activeRef=null; clearInterval(timerInterval);} st.status='pending'; st.duration=0; st.startTime=null; render(); }
  function resetAllSubtasks(taskId){ var t=getTask(taskId); if(!t||!hasSubtasks(t)) return; if(activeRef && activeRef.type==='sub' && activeRef.taskId===taskId){ activeRef=null; clearInterval(timerInterval);} t.subtasks = t.subtasks.map(function(s){ return { id:s.id, name:s.name, status:'pending', duration:0, startTime:null }; }); safeStopTickerIfIdle(); render(); }
  function deleteSubtask(taskId, subId){ var st=getSubtask(taskId, subId); var t=getTask(taskId); if(!t) return; if(st && activeRef && activeRef.type==='sub' && activeRef.taskId===taskId && activeRef.subId===subId){ stopSubtask(taskId,subId); } t.subtasks = t.subtasks.filter(function(s){return s.id!==subId}); safeStopTickerIfIdle(); render(); }

  function completeActive(){ if(!activeRef) return; if(activeRef.type==='task'){ stopParent(activeRef.taskId); } else if(activeRef.type==='sub'){ stopSubtask(activeRef.taskId, activeRef.subId); } }

  // ===== Clear completed =====
  function isTaskFullyCompleted(t){ return (!hasSubtasks(t) && t.parent.status==='completed') || (hasSubtasks(t) && t.subtasks.length>0 && t.subtasks.every(function(s){return s.status==='completed'})); }
  function clearAllCompleted(){ tasks = tasks.filter(function(t){ return !isTaskFullyCompleted(t); }); tasks.forEach(function(t){ if(hasSubtasks(t)){ t.subtasks = t.subtasks.filter(function(s){return s.status!=='completed'}); } }); safeStopTickerIfIdle(); render(); }

  // ===== Timer =====
  function startTicker(){ clearInterval(timerInterval); timerInterval=setInterval(renderTimesOnly,1000); }
  function renderTimesOnly(){ tasks.forEach(function(task){ var tt=document.getElementById('tt-'+task.id); if(tt){ tt.textContent = fmt(totalSeconds(task)); } task.subtasks.forEach(function(st){ var active = activeRef && activeRef.type==='sub' && activeRef.taskId===task.id && activeRef.subId===st.id && st.startTime; if(active){ var el=document.getElementById('st-'+task.id+'-'+st.id); if(el){ var d=st.duration+Math.floor((Date.now()-st.startTime)/1000); el.textContent=fmt(d);} } }); }); }

  // ===== Render =====
  function render(){
    var host=document.getElementById('taskList'); host.innerHTML='';

    tasks.forEach(function(task){
      var card=document.createElement('div'); card.className='card';
      var total=totalSeconds(task); var completed=isTaskCompleted(task);

      var header=document.createElement('div'); header.className='task-header';
      var left=document.createElement('div');
      var title=document.createElement('div'); title.className='task-title title-line'+(completed?' completed':''); title.textContent=task.name; left.appendChild(title);
      var timeWrap=document.createElement('div'); timeWrap.className='muted'; var timeSpan=document.createElement('span'); timeSpan.className='time'+(completed?' dim small':''); timeSpan.id='tt-'+task.id; timeSpan.textContent=fmt(total); timeWrap.appendChild(timeSpan); left.appendChild(timeWrap);
      header.appendChild(left);

      var controls=document.createElement('div'); controls.className='controls';
      if(!hasSubtasks(task)){
        if(task.parent.status!=='in-progress' && task.parent.status!=='completed'){
          var b1=document.createElement('button'); b1.className='btn green'; b1.textContent='â–¶'; b1.setAttribute('aria-label','Start task'); b1.addEventListener('click', function(){ startParent(task.id); }); controls.appendChild(b1);
        }
        if(task.parent.status==='in-progress'){
          var b2=document.createElement('button'); b2.className='btn red'; b2.textContent='â– '; b2.setAttribute('aria-label','Stop task'); b2.addEventListener('click', function(){ stopParent(task.id); }); controls.appendChild(b2);
        }
        if(task.parent.status==='completed'){
          var b3=document.createElement('button'); b3.className='icon-btn gray'; b3.textContent='â†º'; b3.setAttribute('aria-label','Reset task'); b3.addEventListener('click', function(){ resetParent(task.id); }); controls.appendChild(b3);
        }
        var b4=document.createElement('button'); b4.className='icon-btn gray'; b4.textContent='âœ•'; b4.setAttribute('aria-label','Delete task'); b4.addEventListener('click', function(){ deleteTask(task.id); }); controls.appendChild(b4);
      } else {
        var allSubsCompleted = task.subtasks.length>0 && task.subtasks.every(function(s){return s.status==='completed'});
        if(allSubsCompleted){ var rAll=document.createElement('button'); rAll.className='icon-btn gray'; rAll.textContent='â†º'; rAll.setAttribute('aria-label','Reset all subtasks'); rAll.addEventListener('click', function(){ resetAllSubtasks(task.id); }); controls.appendChild(rAll); }
        var del=document.createElement('button'); del.className='icon-btn gray'; del.textContent='âœ•'; del.setAttribute('aria-label','Delete task'); del.addEventListener('click', function(){ deleteTask(task.id); }); controls.appendChild(del);
      }
      header.appendChild(controls);
      card.appendChild(header);

      // Subtasks wrapper & controls
      var subWrap=document.createElement('div'); var isOpen = !task.collapsed; subWrap.className='subtasks'+(isOpen?' open':'');
      var footerCtl=document.createElement('div'); footerCtl.className='row center'; footerCtl.style.marginTop='8px';
      var btn=document.createElement('button'); btn.className='icon-btn';
      if(task.subtasks.length===0){
        btn.textContent = task.collapsed ? 'ï¼‹' : 'â–¾';
        btn.setAttribute('aria-label', task.collapsed ? 'Add first subtask' : 'Collapse');
        btn.addEventListener('click', function(){ if(task.collapsed) expandToAdd(task.id); else collapseCard(task.id); });
      } else {
        btn.textContent = task.collapsed ? 'â–¶' : 'â–¼';
        btn.setAttribute('aria-label', task.collapsed ? 'Expand subtasks' : 'Collapse subtasks');
        btn.addEventListener('click', function(){ toggleCollapse(task.id); });
      }
      footerCtl.appendChild(btn);
      if(task.subtasks.length>0 && task.collapsed){ var cnt=document.createElement('span'); cnt.className='muted small'; cnt.textContent=' ('+task.subtasks.length+')'; footerCtl.appendChild(cnt); }

      var adder=document.createElement('div'); adder.className='row'; adder.style.marginTop='8px'; adder.style.display = (!task.collapsed) ? 'flex' : 'none';
      var subInput=document.createElement('input'); subInput.type='text'; subInput.placeholder='Add subtask...'; subInput.id='subInput-'+task.id; subInput.addEventListener('keydown', function(e){ if(e.key==='Enter'){ addSubtask(task.id); } });
      var subBtn=document.createElement('button'); subBtn.className='icon-btn'; subBtn.textContent='ï¼‹'; subBtn.setAttribute('aria-label','Add subtask'); subBtn.addEventListener('click', function(){ addSubtask(task.id); });
      adder.appendChild(subInput); adder.appendChild(subBtn);

      var list=document.createElement('div'); list.id='subs-'+task.id; list.style.display = task.collapsed ? 'none' : 'block';
      for(var j=0;j<task.subtasks.length;j++){
        var st=task.subtasks[j];
        var isActive = activeRef && activeRef.type==='sub' && activeRef.taskId===task.id && activeRef.subId===st.id && st.startTime;
        var dur=st.duration; if(isActive){ dur += Math.floor((Date.now()-st.startTime)/1000); }
        var row=document.createElement('div'); row.className='subtask '+st.status;
        var l=document.createElement('div'); var ttl=document.createElement('div'); ttl.className='title-line'+(st.status==='completed'?' completed':''); var strong=document.createElement('strong'); strong.textContent=st.name; ttl.appendChild(strong); l.appendChild(ttl); var tw=document.createElement('div'); tw.className='muted'; var ts=document.createElement('span'); ts.className='time'+(st.status==='completed'?' small':''); ts.id='st-'+task.id+'-'+st.id; ts.textContent=fmt(dur); tw.appendChild(ts); l.appendChild(tw); row.appendChild(l);
        var sc=document.createElement('div'); sc.className='sub-controls';
        if(st.status==='pending'){ var s1=document.createElement('button'); s1.className='btn green'; s1.textContent='â–¶'; s1.setAttribute('aria-label','Start subtask'); s1.addEventListener('click', (function(tid,sid){ return function(){ startSubtask(tid, sid); }; })(task.id, st.id)); sc.appendChild(s1); }
        if(st.status==='in-progress'){ var s2=document.createElement('button'); s2.className='btn red'; s2.textContent='â– '; s2.setAttribute('aria-label','Stop subtask'); s2.addEventListener('click', (function(tid,sid){ return function(){ stopSubtask(tid, sid); }; })(task.id, st.id)); sc.appendChild(s2); }
        if(st.status==='completed'){ var s3=document.createElement('button'); s3.className='icon-btn gray'; s3.textContent='â†º'; s3.setAttribute('aria-label','Reset subtask'); s3.addEventListener('click', (function(tid,sid){ return function(){ resetSubtask(tid, sid); }; })(task.id, st.id)); sc.appendChild(s3); }
        var s4=document.createElement('button'); s4.className='icon-btn gray'; s4.textContent='âœ•'; s4.setAttribute('aria-label','Delete subtask'); s4.addEventListener('click', (function(tid,sid){ return function(){ deleteSubtask(tid, sid); }; })(task.id, st.id)); sc.appendChild(s4);
        row.appendChild(sc);
        list.appendChild(row);
      }

      subWrap.appendChild(footerCtl);
      subWrap.appendChild(adder);
      subWrap.appendChild(list);
      card.appendChild(subWrap);

      host.appendChild(card);
    });

    var anyCompletedSub = tasks.some(function(t){ return t.subtasks.some(function(s){return s.status==='completed'}); });
    var anyCompletedParent = tasks.some(function(t){ return !hasSubtasks(t) && t.parent.status==='completed'; });
    document.getElementById('footerBar').style.display = (anyCompletedSub || anyCompletedParent) ? 'block' : 'none';
  }

  // Boot wiring
  document.getElementById('addTaskBtn').addEventListener('click', function(){ addTask(); });
  document.getElementById('taskInput').addEventListener('keydown', function(e){ if(e.key==='Enter'){ addTask(); } });
  document.getElementById('clearAllBtn').addEventListener('click', function(){ clearAllCompleted(); });

  // PWA: register service worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js');
    });
  }

  render();
  </script>
</body>
</html>
